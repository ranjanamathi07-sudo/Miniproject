import React, { useState, useEffect } from 'react';
import { BookOpen, TrendingUp, Brain, Target, Award, Clock, ChevronRight, AlertCircle, CheckCircle, Users, BarChart3 } from 'lucide-react';

const AILearningManagementSystem = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [forecast, setForecast] = useState(null);
  const [adaptivePath, setAdaptivePath] = useState(null);

  // Sample student data with performance metrics
  const [students] = useState([
    {
      id: 1,
      name: "Alex Johnson",
      course: "Data Science Fundamentals",
      currentScore: 78,
      attendance: 92,
      assignmentsCompleted: 15,
      totalAssignments: 18,
      engagementScore: 85,
      learningStyle: "Visual",
      strengths: ["Statistics", "Python Programming"],
      weaknesses: ["Machine Learning Theory"],
      recentScores: [72, 75, 78, 82, 78],
      studyHours: [4, 5, 3, 6, 4]
    },
    {
      id: 2,
      name: "Maria Garcia",
      course: "Web Development",
      currentScore: 92,
      attendance: 98,
      assignmentsCompleted: 18,
      totalAssignments: 18,
      engagementScore: 95,
      learningStyle: "Kinesthetic",
      strengths: ["JavaScript", "UI/UX Design"],
      weaknesses: ["Backend APIs"],
      recentScores: [88, 90, 92, 94, 92],
      studyHours: [5, 6, 5, 7, 6]
    },
    {
      id: 3,
      name: "James Chen",
      course: "Artificial Intelligence",
      currentScore: 65,
      attendance: 75,
      assignmentsCompleted: 12,
      totalAssignments: 18,
      engagementScore: 62,
      learningStyle: "Auditory",
      strengths: ["Neural Networks"],
      weaknesses: ["Linear Algebra", "Optimization"],
      recentScores: [70, 68, 65, 62, 65],
      studyHours: [2, 3, 2, 3, 2]
    }
  ]);

  const [curriculum] = useState({
    "Data Science Fundamentals": [
      { id: 1, name: "Introduction to Python", difficulty: 1, completed: true },
      { id: 2, name: "Data Structures", difficulty: 2, completed: true },
      { id: 3, name: "Statistics Basics", difficulty: 2, completed: true },
      { id: 4, name: "Data Visualization", difficulty: 2, completed: false },
      { id: 5, name: "Machine Learning Introduction", difficulty: 3, completed: false },
      { id: 6, name: "Deep Learning Fundamentals", difficulty: 4, completed: false }
    ],
    "Web Development": [
      { id: 1, name: "HTML & CSS", difficulty: 1, completed: true },
      { id: 2, name: "JavaScript Basics", difficulty: 2, completed: true },
      { id: 3, name: "React Framework", difficulty: 3, completed: true },
      { id: 4, name: "Backend Development", difficulty: 3, completed: false },
      { id: 5, name: "Database Design", difficulty: 3, completed: false },
      { id: 6, name: "Full Stack Project", difficulty: 4, completed: false }
    ],
    "Artificial Intelligence": [
      { id: 1, name: "AI Foundations", difficulty: 2, completed: true },
      { id: 2, name: "Linear Algebra Review", difficulty: 3, completed: true },
      { id: 3, name: "Optimization Techniques", difficulty: 3, completed: false },
      { id: 4, name: "Neural Networks", difficulty: 3, completed: false },
      { id: 5, name: "Computer Vision", difficulty: 4, completed: false },
      { id: 6, name: "NLP Applications", difficulty: 4, completed: false }
    ]
  });

  // AI-powered performance forecasting
  const generateForecast = async (student) => {
    setIsAnalyzing(true);
    
    // Simulate AI processing with Anthropic API call
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [
          {
            role: "user",
            content: "Analyze this student's performance data and provide a detailed forecast: "
            
Student: ${student.name}
Current Score: ${student.currentScore}%
Attendance: ${student.attendance}%
Assignments: ${student.assignmentsCompleted}/${student.totalAssignments}
Engagement: ${student.engagementScore}%
Learning Style: ${student.learningStyle}
Recent Scores: ${student.recentScores.join(', ')}
Study Hours per Week: ${student.studyHours.join(', ')}
Strengths: ${student.strengths.join(', ')}
Weaknesses: ${student.weaknesses.join(', ')}

Provide a JSON response with:
1. predictedFinalScore (number 0-100)
2. confidence (number 0-100)
3. trend ("improving", "stable", "declining")
4. riskLevel ("low", "medium", "high")
5. keyInsights (array of 3-4 strings)
6. recommendations (array of 3-4 specific action items)

Respond ONLY with valid JSON, no preamble.`
          }
        ]
      })
    });

    const data = await response.json();
    const text = data.content.find(c => c.type === 'text')?.text || '{}';
    const cleanText = text.replace(/```json|```/g, '').trim();
    const forecastData = JSON.parse(cleanText);
    
    setForecast(forecastData);
    setIsAnalyzing(false);
  };

  // AI-powered adaptive curriculum
  const generateAdaptivePath = async (student) => {
    setIsAnalyzing(true);
    
    const courseCurriculum = curriculum[student.course];
    
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [
          {
            role: "user",
            content: `Create a personalized adaptive learning path for this student:

Student: ${student.name}
Learning Style: ${student.learningStyle}
Current Performance: ${student.currentScore}%
Strengths: ${student.strengths.join(', ')}
Weaknesses: ${student.weaknesses.join(', ')}
Engagement: ${student.engagementScore}%

Course Modules:
${courseCurriculum.map(m => `- ${m.name} (Difficulty ${m.difficulty}, ${m.completed ? 'Completed' : 'Pending'})`).join('\n')}

Provide a JSON response with:
1. recommendedModules (array of next 3 modules to focus on with names)
2. difficultyAdjustment ("increase", "maintain", "decrease")
3. learningResources (array of 4 personalized resource types based on learning style)
4. studyPlan (string with weekly time allocation)
5. milestones (array of 3 short-term goals)

Respond ONLY with valid JSON, no preamble.`
          }
        ]
      })
    });

    const data = await response.json();
    const text = data.content.find(c => c.type === 'text')?.text || '{}';
    const cleanText = text.replace(/```json|```/g, '').trim();
    const pathData = JSON.parse(cleanText);
    
    setAdaptivePath(pathData);
    setIsAnalyzing(false);
  };

  const handleStudentSelect = (student) => {
    setSelectedStudent(student);
    setForecast(null);
    setAdaptivePath(null);
  };

  const getRiskColor = (level) => {
    switch(level) {
      case 'low': return 'text-green-600 bg-green-50';
      case 'medium': return 'text-yellow-600 bg-yellow-50';
      case 'high': return 'text-red-600 bg-red-50';
      default: return 'text-gray-600 bg-gray-50';
    }
  };

  const getTrendIcon = (trend) => {
    if (trend === 'improving') return <TrendingUp className="w-4 h-4 text-green-600" />;
    if (trend === 'declining') return <AlertCircle className="w-4 h-4 text-red-600" />;
    return <CheckCircle className="w-4 h-4 text-blue-600" />;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="bg-indigo-600 p-2 rounded-lg">
                <Brain className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">AI-Powered LMS</h1>
                <p className="text-sm text-gray-600">Performance Forecasting & Adaptive Learning</p>
              </div>
            </div>
            <div className="flex items-center space-x-2 text-sm text-gray-600">
              <Users className="w-4 h-4" />
              <span>{students.length} Active Students</span>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-6 py-8">
        {/* Navigation Tabs */}
        <div className="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-6">
          {['dashboard', 'students', 'analytics'].map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${
                activeTab === tab
                  ? 'bg-white text-indigo-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </button>
          ))}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Student List */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-4 border-b border-gray-200 bg-gray-50">
                <h3 className="font-semibold text-gray-900 flex items-center">
                  <Users className="w-4 h-4 mr-2" />
                  Students
                </h3>
              </div>
              <div className="divide-y divide-gray-200">
                {students.map(student => (
                  <button
                    key={student.id}
                    onClick={() => handleStudentSelect(student)}
                    className={`w-full p-4 text-left hover:bg-gray-50 transition-colors ${
                      selectedStudent?.id === student.id ? 'bg-indigo-50 border-l-4 border-indigo-600' : ''
                    }`}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium text-gray-900">{student.name}</span>
                      <ChevronRight className="w-4 h-4 text-gray-400" />
                    </div>
                    <p className="text-sm text-gray-600 mb-2">{student.course}</p>
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-500">Score: {student.currentScore}%</span>
                      <span className={`px-2 py-1 rounded-full ${
                        student.currentScore >= 80 ? 'bg-green-100 text-green-700' :
                        student.currentScore >= 70 ? 'bg-yellow-100 text-yellow-700' :
                        'bg-red-100 text-red-700'
                      }`}>
                        {student.currentScore >= 80 ? 'Excellent' :
                         student.currentScore >= 70 ? 'Good' : 'At Risk'}
                      </span>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            {/* Quick Stats */}
            <div className="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
              <h4 className="font-semibold text-gray-900 mb-3 flex items-center">
                <BarChart3 className="w-4 h-4 mr-2" />
                Class Overview
              </h4>
              <div className="space-y-3">
                <div>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="text-gray-600">Average Score</span>
                    <span className="font-medium text-gray-900">
                      {Math.round(students.reduce((sum, s) => sum + s.currentScore, 0) / students.length)}%
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-indigo-600 h-2 rounded-full"
                      style={{ width: `${students.reduce((sum, s) => sum + s.currentScore, 0) / students.length}%` }}
                    />
                  </div>
                </div>
                <div>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="text-gray-600">Avg Engagement</span>
                    <span className="font-medium text-gray-900">
                      {Math.round(students.reduce((sum, s) => sum + s.engagementScore, 0) / students.length)}%
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-purple-600 h-2 rounded-full"
                      style={{ width: `${students.reduce((sum, s) => sum + s.engagementScore, 0) / students.length}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Main Content Area */}
          <div className="lg:col-span-2">
            {!selectedStudent ? (
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                <BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Select a Student</h3>
                <p className="text-gray-600">Choose a student from the list to view AI-powered forecasting and personalized learning paths</p>
              </div>
            ) : (
              <div className="space-y-6">
                {/* Student Header */}
                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-sm p-6 text-white">
                  <h2 className="text-2xl font-bold mb-2">{selectedStudent.name}</h2>
                  <p className="text-indigo-100 mb-4">{selectedStudent.course}</p>
                  <div className="grid grid-cols-4 gap-4">
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <div className="text-xs text-indigo-100 mb-1">Current Score</div>
                      <div className="text-2xl font-bold">{selectedStudent.currentScore}%</div>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <div className="text-xs text-indigo-100 mb-1">Attendance</div>
                      <div className="text-2xl font-bold">{selectedStudent.attendance}%</div>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <div className="text-xs text-indigo-100 mb-1">Engagement</div>
                      <div className="text-2xl font-bold">{selectedStudent.engagementScore}%</div>
                    </div>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3">
                      <div className="text-xs text-indigo-100 mb-1">Assignments</div>
                      <div className="text-2xl font-bold">{selectedStudent.assignmentsCompleted}/{selectedStudent.totalAssignments}</div>
                    </div>
                  </div>
                </div>

                {/* AI Analysis Buttons */}
                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={() => generateForecast(selectedStudent)}
                    disabled={isAnalyzing}
                    className="bg-white border-2 border-indigo-200 rounded-xl p-6 text-left hover:border-indigo-400 hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Target className="w-8 h-8 text-indigo-600 mb-3" />
                    <h3 className="font-semibold text-gray-900 mb-1">Performance Forecast</h3>
                    <p className="text-sm text-gray-600">AI-powered prediction of final outcomes</p>
                  </button>
                  <button
                    onClick={() => generateAdaptivePath(selectedStudent)}
                    disabled={isAnalyzing}
                    className="bg-white border-2 border-purple-200 rounded-xl p-6 text-left hover:border-purple-400 hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Brain className="w-8 h-8 text-purple-600 mb-3" />
                    <h3 className="font-semibold text-gray-900 mb-1">Adaptive Curriculum</h3>
                    <p className="text-sm text-gray-600">Personalized learning path generation</p>
                  </button>
                </div>

                {/* Loading State */}
                {isAnalyzing && (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 border-t-indigo-600 mx-auto mb-4"></div>
                    <p className="text-gray-600">AI is analyzing student data...</p>
                  </div>
                )}

                {/* Forecast Results */}
                {forecast && !isAnalyzing && (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-gray-200">
                      <h3 className="font-semibold text-gray-900 flex items-center">
                        <Target className="w-5 h-5 mr-2 text-indigo-600" />
                        Performance Forecast
                      </h3>
                    </div>
                    <div className="p-6">
                      <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="text-center">
                          <div className="text-3xl font-bold text-indigo-600 mb-1">{forecast.predictedFinalScore}%</div>
                          <div className="text-sm text-gray-600">Predicted Final Score</div>
                        </div>
                        <div className="text-center">
                          <div className="flex items-center justify-center mb-1">
                            {getTrendIcon(forecast.trend)}
                            <span className="ml-2 text-lg font-semibold text-gray-900 capitalize">{forecast.trend}</span>
                          </div>
                          <div className="text-sm text-gray-600">Performance Trend</div>
                        </div>
                        <div className="text-center">
                          <div className={`inline-block px-3 py-1 rounded-full text-sm font-semibold mb-1 ${getRiskColor(forecast.riskLevel)}`}>
                            {forecast.riskLevel.toUpperCase()} RISK
                          </div>
                          <div className="text-sm text-gray-600">Risk Level</div>
                        </div>
                      </div>

                      <div className="mb-6">
                        <div className="flex justify-between text-sm mb-2">
                          <span className="text-gray-600">Confidence Level</span>
                          <span className="font-medium text-gray-900">{forecast.confidence}%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                          <div 
                            className="bg-gradient-to-r from-indigo-600 to-purple-600 h-3 rounded-full transition-all duration-500"
                            style={{ width: `${forecast.confidence}%` }}
                          />
                        </div>
                      </div>

                      <div className="mb-6">
                        <h4 className="font-semibold text-gray-900 mb-3">Key Insights</h4>
                        <div className="space-y-2">
                          {forecast.keyInsights?.map((insight, idx) => (
                            <div key={idx} className="flex items-start">
                              <CheckCircle className="w-4 h-4 text-green-600 mr-2 mt-0.5 flex-shrink-0" />
                              <span className="text-sm text-gray-700">{insight}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div>
                        <h4 className="font-semibold text-gray-900 mb-3">Recommendations</h4>
                        <div className="space-y-2">
                          {forecast.recommendations?.map((rec, idx) => (
                            <div key={idx} className="flex items-start bg-indigo-50 rounded-lg p-3">
                              <Award className="w-4 h-4 text-indigo-600 mr-2 mt-0.5 flex-shrink-0" />
                              <span className="text-sm text-gray-700">{rec}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Adaptive Path Results */}
                {adaptivePath && !isAnalyzing && (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-gray-200">
                      <h3 className="font-semibold text-gray-900 flex items-center">
                        <Brain className="w-5 h-5 mr-2 text-purple-600" />
                        Personalized Learning Path
                      </h3>
                    </div>
                    <div className="p-6">
                      <div className="mb-6">
                        <h4 className="font-semibold text-gray-900 mb-3">Recommended Focus Areas</h4>
                        <div className="space-y-3">
                          {adaptivePath.recommendedModules?.map((module, idx) => (
                            <div key={idx} className="flex items-center bg-purple-50 rounded-lg p-4">
                              <div className="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">
                                {idx + 1}
                              </div>
                              <span className="font-medium text-gray-900">{module}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                        <div className="flex items-center mb-2">
                          <TrendingUp className="w-5 h-5 text-indigo-600 mr-2" />
                          <h4 className="font-semibold text-gray-900">Difficulty Adjustment</h4>
                        </div>
                        <p className="text-gray-700 capitalize">
                          <span className="font-medium">{adaptivePath.difficultyAdjustment}</span> current difficulty level
                        </p>
                      </div>

                      <div className="mb-6">
                        <h4 className="font-semibold text-gray-900 mb-3 flex items-center">
                          <BookOpen className="w-4 h-4 mr-2" />
                          Personalized Resources
                        </h4>
                        <div className="grid grid-cols-2 gap-3">
                          {adaptivePath.learningResources?.map((resource, idx) => (
                            <div key={idx} className="flex items-center bg-gray-50 rounded-lg p-3">
                              <CheckCircle className="w-4 h-4 text-green-600 mr-2" />
                              <span className="text-sm text-gray-700">{resource}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="mb-6 p-4 bg-indigo-50 rounded-lg">
                        <div className="flex items-center mb-2">
                          <Clock className="w-5 h-5 text-indigo-600 mr-2" />
                          <h4 className="font-semibold text-gray-900">Study Plan</h4>
                        </div>
                        <p className="text-gray-700">{adaptivePath.studyPlan}</p>
                      </div>

                      <div>
                        <h4 className="font-semibold text-gray-900 mb-3">Short-term Milestones</h4>
                        <div className="space-y-2">
                          {adaptivePath.milestones?.map((milestone, idx) => (
                            <div key={idx} className="flex items-start">
                              <Target className="w-4 h-4 text-purple-600 mr-2 mt-0.5 flex-shrink-0" />
                              <span className="text-sm text-gray-700">{milestone}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
